\documentclass{article}

\usepackage[american]{babel}
\hyphenation{
Fab-Fil-ter
}
\usepackage{csquotes}

\usepackage[
  landscape,
  margin=0.5in,
  footskip=0.25in
]{geometry}
\parindent=0sp
\parskip=0.125cm
\topskip=1sp

\usepackage[
  backend=biber,
  isbn=false
]{biblatex-chicago}
\bibliography{instrumentation-cheat-sheet}

\usepackage{array}
\usepackage{booktabs}
\usepackage{datetime2}
\usepackage{fancyhdr}
\usepackage{multicol}
\usepackage{multirow}

\usepackage[no-config]{fontspec}
\setmainfont{Libertinus Sans}[Numbers=Proportional]
\setmonofont{TeX Gyre Cursor}
\newfontfamily\symbolFont{Libertinus Serif}

\usepackage{newunicodechar}
\newunicodechar{♯}{{\symbolFont\char`\♯}}
\newunicodechar{♭}{\hspace{-0.15ex}{\symbolFont\char`\♭}\hspace{-0.15ex}}

\usepackage{tikz}
\usetikzlibrary{calc}
\usetikzlibrary{positioning}

\definecolor{primary-ambitus-color}  {gray}{0.55}
\definecolor{secondary-ambitus-color}{gray}{0.72}
\definecolor{ambitus-bracket-color}  {gray}{0.5}
\definecolor{white-note-guide-color} {gray}{0.975}
\definecolor{black-key-color}        {gray}{0.3}
\definecolor{black-note-guide-color} {gray}{0.93}
\definecolor{note-label-color}       {gray}{0.7}
\definecolor{frequency-label-color}  {gray}{0.7}
\definecolor{white-note-number-color}{gray}{0.8}
\definecolor{black-note-number-color}{gray}{0.525}

\tikzset{annotation/.style={font=\itshape, text badly ragged}}
\tikzset{instrument label/.style={}}

\input .octave-offset.tex

\usepackage[
  pdftitle={Instrumentation Cheat Sheet},
  pdfauthor={Nathan Whetsell},
  hidelinks
]{hyperref}

\makeatletter
\renewcommand\section{\@startsection {section}{1}{\z@}%
                                     {-2ex \@plus -1ex \@minus -.2ex}%
                                     {1sp \@plus .2ex}%
                                     {\normalfont\normalsize}}%
\makeatother

\begin{document}
\frenchspacing
\pagenumbering{gobble}
\pagestyle{fancyplain}
\fancyhf{}
\renewcommand{\headrulewidth}{0sp}
\renewcommand{\footrulewidth}{0sp}
\lfoot{\fancyplain{}{\tiny commit \ttfamily \input|"git rev-parse --short HEAD"}}
\rfoot{\fancyplain{}{\tiny\DTMsetstyle{iso}\today}}

\section*{Instrumentation Cheat Sheet}
\vfil

\def\totalNoteCount{90}
\pgfmathsetmacro{\blackKeyWidth}{\textwidth / \totalNoteCount}

\begin{tikzpicture}[
  every node/.style={
    node font=\tiny,
    inner sep=0,
    outer sep=0
  },
  x=\blackKeyWidth
]
  \input .note-metrics
  \pgfmathsetmacro{\noteImageScaleFactor}{(87 * \blackKeyWidth) / (\maxNoteMidpoint - \minNoteMidpoint)}

  \def\ambitusBarHeight{0.155}
  \def\ambitusBarSeparation{0.45}
  \pgfmathsetmacro{\keyboardHeight}{6 * \ambitusBarHeight}
  \def\keyboardPaddingBelow{1}
  \def\keyboardPaddingAbove{1}

  \def\percussionInstrumentCount{9} % Number of percussion instruments, except timpani
  \def\windInstrumentCount{30}      % Number of wind instruments

  \pgfmathsetmacro{\keyboardYOffset}{
    (
      % strings
      4 * (5 + 0.25) + 3
      % timpani
      + 5
      % instrument family separation
      + 2
      % instruments
      + (\percussionInstrumentCount - 3) * (1 + \ambitusBarSeparation)
      % padding
      + \keyboardPaddingBelow
    ) * \ambitusBarHeight
  }

  \newdimen\notesTopHeight
  \settoheight{\notesTopHeight}{\includegraphics[scale=\noteImageScaleFactor]{notes-top.pdf}}

  \pgfmathsetmacro{\noteGuideTop}{
    \keyboardYOffset + \keyboardHeight +
    (
      % padding
      \keyboardPaddingAbove
      % instruments
      + \windInstrumentCount * (1 + \ambitusBarSeparation) - 3 * \ambitusBarSeparation
      % instrument family separation
      + 2 * 2
    ) * \ambitusBarHeight
    + \notesTopHeight * 2.54/72.27
  }

  \def\bottomNotePadding{0.1}
  \pgfmathsetmacro{\noteGuideBottom}{\noteImageScaleFactor * -\minNoteY * 2.54/72.27 + \bottomNotePadding}

  \path[use as bounding box] (0, -\noteGuideBottom) rectangle (\totalNoteCount * \blackKeyWidth, \noteGuideTop);

  % Add frequencies.
  \pgfkeys{/pgf/number format/.cd,
    assume math mode=true, % don’t switch to math mode (which would use the wrong font)
    fixed, % round numbers to a fixed number of digits after the decimal point
    precision=1 % round to the nearest tenth
  }

  % The highest note is the D five half-steps above the A at 3520 Hz, so in most
  % DAWs using 12-EDO tuning, the fundamental frequency of the D will be
  % 2^(5/12) * 3520 Hz. Use a LaTeX3 floating point expression because the PGF
  % math engine is a bit too imprecise to compute this.
  \ExplSyntaxOn
  \def\maxFrequency{\fp_to_decimal:n {2^(5/12) * 3520}}
  \ExplSyntaxOff

  \def\minFrequency{27.5}

  \newtoggle{didPrintFrequencyUnit}
  \foreach \frequency in {
      % Frequencies of A notes
      \minFrequency, 55, 110, 220, 440, 880, 1760, 3520,
      % ISO 266 frequencies
        31.5, 40,  50,  63,  80,  100,  125,  160,  200,  250,
       315,  400, 500, 630, 800, 1000, 1250, 1600, 2000, 2500,
      3150, 4000,
      % Max frequency
      \maxFrequency
    } {
      \pgfmathparse{
        89 * ln(\frequency / \minFrequency) / ln(\maxFrequency / \minFrequency) + 0.5
        % This is a simplification of
        %   (ln(\frequency) - ln(\minFrequency)) * (89.5 - 0.5) / (ln(\maxFrequency) - ln(\minFrequency)) + 0.5
      }
      \draw[frequency-label-color] (\pgfmathresult, -\noteGuideBottom) -- ++(0, -0.05) node[anchor=north,yshift=-0.2ex] {
        \pgfmathprintnumber{\frequency} \iftoggle{didPrintFrequencyUnit}{}{Hz\global\toggletrue{didPrintFrequencyUnit}}
      };
  }

  % Draw white note guides.
  \NewDocumentCommand\AToDGuidePaths{}{
    % A
    rectangle ++(1, \noteGuideBottom + \noteGuideTop) ++(1, -\noteGuideBottom - \noteGuideTop)
    % B
    rectangle ++(1, \noteGuideBottom + \noteGuideTop) ++(2, -\noteGuideBottom - \noteGuideTop)
    % D
    rectangle ++(1, \noteGuideBottom + \noteGuideTop) ++(1, -\noteGuideBottom - \noteGuideTop)
  }
  \pgfmathsetmacro{\lastOctave}{div(\totalNoteCount, 12) - 1}
  \def\EFSeparation{0.05}
  \filldraw[
    draw=white-note-guide-color,
    fill=white-note-guide-color
  ]
    (0, -\noteGuideBottom)
    \foreach \octave in { 0, ..., \lastOctave } {
      \AToDGuidePaths
      % E
      rectangle ++(1 - \EFSeparation, \noteGuideBottom + \noteGuideTop) ++(2 * \EFSeparation, -\noteGuideBottom - \noteGuideTop)
      % F
      rectangle ++(1 - \EFSeparation, \noteGuideBottom + \noteGuideTop) ++(1, -\noteGuideBottom - \noteGuideTop)
      % G
      rectangle ++(1, \noteGuideBottom + \noteGuideTop) ++(1, -\noteGuideBottom - \noteGuideTop)
    }
    \AToDGuidePaths;

  % Draw black note guides.
  \NewDocumentCommand\BFlatToCSharpGuidePaths{}{
    % A♯/B♭
    rectangle ++(1, \noteGuideBottom + \noteGuideTop) ++(2, -\noteGuideBottom - \noteGuideTop)
    % C♯/D♭
    rectangle ++(1, \noteGuideBottom + \noteGuideTop) ++(1, -\noteGuideBottom - \noteGuideTop)
  }
  \filldraw[
    draw=black-note-guide-color,
    fill=black-note-guide-color
  ]
    (1, -\noteGuideBottom)
    \foreach \octave in { 0, ..., \lastOctave } {
      \BFlatToCSharpGuidePaths
      % D♯/E♭
      rectangle ++(1, \noteGuideBottom + \noteGuideTop) ++(2, -\noteGuideBottom - \noteGuideTop)
      % F♯/G♭
      rectangle ++(1, \noteGuideBottom + \noteGuideTop) ++(1, -\noteGuideBottom - \noteGuideTop)
      % G♯/A♭
      rectangle ++(1, \noteGuideBottom + \noteGuideTop) ++(1, -\noteGuideBottom - \noteGuideTop)
    }
    \BFlatToCSharpGuidePaths;

  % Draw the keyboard.
  \pgfmathsetmacro{\blackKeyHeight}{0.625 * \keyboardHeight}
  \pgfmathsetmacro{\whiteToBlackKeyDistance}{\keyboardHeight - \blackKeyHeight}
  \begin{scope}[yshift=\keyboardYOffset cm]
    \begin{scope}[
      draw=black-key-color,
      fill=black-key-color
    ]
      \draw[fill=white] (0, 0) rectangle (\totalNoteCount, \keyboardHeight);

      \NewDocumentCommand\AToCSharpKeyPaths{}{
        ++( 1.5, 0) -- ++(0, \whiteToBlackKeyDistance)
        ++(-0.5, 0) rectangle ++(1, \blackKeyHeight) % A♯/B♭
        ++( 1  , -\keyboardHeight) -- ++(0, \keyboardHeight)
        ++( 1.5, -\keyboardHeight) -- ++(0, \whiteToBlackKeyDistance)
        ++(-0.5, 0) rectangle ++(1, \blackKeyHeight) % C♯/D♭
      }
      \filldraw (0, 0)
      \foreach \octave in { 0, ..., \lastOctave } {
        \AToCSharpKeyPaths
        ++( 1.5, -\keyboardHeight) -- ++(0, \whiteToBlackKeyDistance)
        ++(-0.5, 0) rectangle ++(1, \blackKeyHeight) % D♯/E♭
        ++( 1  , -\keyboardHeight) -- ++(0, \keyboardHeight)
        ++( 1.5, -\keyboardHeight) -- ++(0, \whiteToBlackKeyDistance)
        ++(-0.5, 0) rectangle ++(1, \blackKeyHeight) % F♯/G♭
        ++( 1.5, -\keyboardHeight) -- ++(0, \whiteToBlackKeyDistance)
        ++(-0.5, 0) rectangle ++(1, \blackKeyHeight) % G♯/A♭
        ++( 0  , -\keyboardHeight)
      }
      \AToCSharpKeyPaths;
    \end{scope}

    % Label notes.
    \begin{scope}[
      anchor=north west,
      minimum width=\blackKeyWidth,
      text=note-label-color
    ]
      % Label Cs.
      \foreach \noteNumber in { 24, 36, ..., 108 } {
        \pgfmathsetmacro{\octave}{int(div(\noteNumber, 12) - \octaveOffset)}
        \path
          (\noteNumber - 21, \keyboardHeight)
          node[yshift=-0.75ex] { C\octave }
          ++(0, \noteGuideTop - \keyboardHeight - \keyboardYOffset)
          node { C\octave };
        \ifnum\noteNumber>24\relax
          \path (\noteNumber - 21, -\noteGuideBottom - \keyboardYOffset) node[anchor=south west,yshift=0.1ex] { C\octave };
        \fi
      }
      % Label concert pitch (A above middle C).
      \def\noteNumber{69}
      \pgfmathsetmacro{\octave}{int(div(\noteNumber, 12) - \octaveOffset)}
      \path
        (\noteNumber - 21, \keyboardHeight)
        node[yshift=-0.75ex] { A\octave }
        ++(0, \noteGuideTop - \keyboardHeight - \keyboardYOffset)
        node { A\octave }
        ++(0, -\noteGuideBottom - \noteGuideTop)
        node[anchor=south west,yshift=0.1ex] { A\octave };
    \end{scope}

    % Add MIDI note numbers.
    \node[
      align=center,
      anchor=south east,
      inner xsep=1pt,
      minimum height=\keyboardHeight cm,
      text=white-note-number-color
    ] at (0, 0) { MIDI\\[-0.5ex] note nos. };

    \begin{scope}[
      anchor=mid west,
      minimum width=\blackKeyWidth,
    ]
      \foreach \noteNumber in { 21, ..., 110 } {
        \pgfmathsetmacro{\pitchNumber}{mod(\noteNumber, 12)}
        \pgfmathparse{
          \pitchNumber ==  1 ||
          \pitchNumber ==  3 ||
          \pitchNumber ==  6 ||
          \pitchNumber ==  8 ||
          \pitchNumber == 10
        }
        \ifnum\pgfmathresult>0\relax
          \def\noteNumberColor{black-note-number-color}
        \else
          \def\noteNumberColor{white-note-number-color}
        \fi
        \node[text=\noteNumberColor] at (\noteNumber - 21, 0.5 * \keyboardHeight) { \noteNumber };
      }
    \end{scope}
  \end{scope}

  \pgfmathsetmacro{\labelOffset}{-0.1 * \blackKeyWidth}
  \gdef\ambitusBarOffset{-1 - \ambitusBarSeparation}

  \ExplSyntaxOn

  \seq_const_from_clist:Nn \note_names { C, D♭, D, E♭, E, F, F♯, G, A♭, A, B♭, B }
  \NewDocumentCommand { \noteName } { m }
    {
      \seq_item:Nn \note_names { \int_mod:nn { #1 } { 12 } + 1 }
      \int_eval:n { \int_div_truncate:nn { #1 } { 12 } - \octaveOffset }
    }

  \def\lowNodeName{}
  \def\highNodeName{}

  \int_new:N  \l_primary_note_start_int
  \tl_new:N   \l_primary_note_start_label_tl
  \int_new:N  \l_primary_note_end_int
  \tl_new:N   \l_primary_note_end_label_tl
  \tl_new:N   \l_primary_color_tl
  \int_new:N  \l_secondary_note_start_int
  \int_new:N  \l_secondary_note_end_int
  \tl_new:N   \l_long_name_tl
  \tl_new:N   \l_short_name_tl
  \bool_new:N \l_is_continuation_bool

  \keys_define:nn { ambitus } {
    primary-note-start       .int_set:N  = \l_primary_note_start_int,
    primary-note-start       .groups:n   = { primary-note-start },
    primary-note-start-label .tl_set:N   = \l_primary_note_start_label_tl,
    primary-note-end         .int_set:N  = \l_primary_note_end_int,
    primary-note-end-label   .tl_set:N   = \l_primary_note_end_label_tl,
    primary-color            .tl_set:N   = \l_primary_color_tl,
    secondary-note-start     .int_set:N  = \l_secondary_note_start_int,
    secondary-note-start     .groups:n   = { secondary-notes },
    secondary-note-end       .int_set:N  = \l_secondary_note_end_int,
    secondary-note-end       .groups:n   = { secondary-notes },
    long-name                .tl_set:N   = \l_long_name_tl,
    short-name               .tl_set:N   = \l_short_name_tl,
    is-continuation          .bool_set:N = \l_is_continuation_bool,
    is-continuation          .default:n  = true
  }

  \bool_new:N \l_secondary_note_start_is_below_primary_bool
  \bool_new:N \l_secondary_note_end_is_above_primary_bool

  \NewDocumentCommand\drawAmbitus{m}{
    \tl_clear:N \l_primary_note_start_label_tl
    \tl_clear:N \l_primary_note_end_label_tl
    \tl_set:Nn  \l_primary_color_tl { primary-ambitus-color }
    \tl_clear:N \l_long_name_tl
    \tl_clear:N \l_short_name_tl

    \keys_set_groups:nnn { ambitus } { primary-note-start } { #1 }

    \int_set_eq:NN \l_primary_note_end_int \l_primary_note_start_int

    \keys_set_exclude_groups:nnn { ambitus } { primary-note-start, secondary-notes } { #1 }

    \int_set_eq:NN \l_secondary_note_start_int \l_primary_note_end_int
    \int_set_eq:NN \l_secondary_note_end_int \l_primary_note_start_int

    \keys_set_groups:nnn { ambitus } { secondary-notes } { #1 }

    \bool_if:nF { \l_is_continuation_bool } {
      \pgfmathsetmacro{\ambitusBarOffset}{\ambitusBarOffset + 1 + \ambitusBarSeparation}
      \xdef\ambitusBarOffset{\ambitusBarOffset}
    }

    \tl_if_empty:NF \l_long_name_tl {
      \tl_set_eq:NN \l_tmpa_tl \l_long_name_tl
      \tl_replace_all:Nnn \l_tmpa_tl { ♭ } { -flat }
      \tl_remove_all:Nn \l_tmpa_tl { . }
      \tl_remove_all:Nn \l_tmpa_tl { ( }
      \tl_remove_all:Nn \l_tmpa_tl { ) }
      \edef\lowNodeName{\l_tmpa_tl-low}
      \edef\highNodeName{\l_tmpa_tl-high}
    }

    \begin{scope}[node~ distance=0]
      \pgfmathsetmacro{\ambitusMinY}{\ambitusBarOffset * \ambitusBarHeight}

      \begin{scope}[rounded~ corners=0.5bp]
        \bool_set:Nn \l_secondary_note_start_is_below_primary_bool
                     { \int_compare_p:nNn { \l_secondary_note_start_int } < { \l_primary_note_start_int } }
        \bool_set:Nn \l_secondary_note_end_is_above_primary_bool
                     { \int_compare_p:nNn { \l_secondary_note_end_int } > { \l_primary_note_end_int } }

        \bool_if:nT { \l_secondary_note_start_is_below_primary_bool || \l_secondary_note_end_is_above_primary_bool } {
          \path[fill=secondary-ambitus-color]
            (\l_secondary_note_start_int - 21, \ambitusMinY)
            rectangle
            ++(\l_secondary_note_end_int - \l_secondary_note_start_int + 1, \ambitusBarHeight);
        }

        \path[fill=\l_primary_color_tl]
          (\l_primary_note_start_int - 21, \ambitusMinY)
          rectangle
          ++(\l_primary_note_end_int - \l_primary_note_start_int + 1, \ambitusBarHeight);

        \node[anchor=south~ west, text=white] (\lowNodeName) at (\l_primary_note_start_int - 21, \ambitusMinY) {
          \tl_if_empty:NTF \l_primary_note_start_label_tl
            { \noteName{\l_primary_note_start_int} }
            { \l_primary_note_start_label_tl }
        };

        \bool_if:nT { \l_secondary_note_start_is_below_primary_bool } {
          \node[anchor=south~ west, text=white] (\lowNodeName) at (\l_secondary_note_start_int - 21, \ambitusMinY) {
            \noteName{\l_secondary_note_start_int}
          };
        }

        \node[anchor=south~ west, text=white] (\highNodeName) at (\l_primary_note_end_int - 21, \ambitusMinY) {
          \int_compare:nNnT { \l_primary_note_start_int } < { \l_primary_note_end_int } {
            \tl_if_empty:NTF \l_primary_note_end_label_tl
              { \noteName{\l_primary_note_end_int} }
              { \l_primary_note_end_label_tl }
          }
        };

        \bool_if:nT { \l_secondary_note_end_is_above_primary_bool } {
          \node[anchor=south~ west, text=white] (\highNodeName) at (\l_secondary_note_end_int - 21, \ambitusMinY) {
            \noteName{\l_secondary_note_end_int}
          };
        }

        \node[base~ left=of~ \lowNodeName, xshift=\labelOffset, instrument~ label] { \l_long_name_tl };
        \node[base~ right=of~ \highNodeName, xshift=-\labelOffset] { \l_short_name_tl };
      \end{scope}
    \end{scope}
  }

  \ExplSyntaxOff

  \NewDocumentEnvironment{instrumentFamily}{}{
    \def\defaultInstrumentFamilySeparation{1.5}
    \gdef\instrumentFamilySeparation{\defaultInstrumentFamilySeparation}
  }{
    \pgfmathsetmacro{\ambitusBarOffset}{\ambitusBarOffset + \instrumentFamilySeparation}
    \xdef\ambitusBarOffset{\ambitusBarOffset}

    \gdef\instrumentFamilySeparation{\defaultInstrumentFamilySeparation}
  }

  \NewDocumentEnvironment{bracketedAmbitus}{m o}{
    \def\ambitusBarSeparation{0.25}

    \newtoggle{didRun}

    \NewCommandCopy\drawAmbitusOriginal\drawAmbitus
    \RenewDocumentCommand\drawAmbitus{m}{
      \iftoggle{didRun}{
        \def\lowNodeName{}
        \def\highNodeName{high}
      }{
        \def\lowNodeName{low}
        \def\highNodeName{}
        \toggletrue{didRun}
      }
      \drawAmbitusOriginal{##1}
    }

    \begin{scope}[name prefix=#1-]
  }{
    \end{scope}

    \path[draw=ambitus-bracket-color]
      let \p1=(#1-low), \p2=(#1-high) in
      (\x1 - 0.25 * \blackKeyWidth, \y1 - \ambitusBarHeight cm) --
      (\x1 - 0.75 * \blackKeyWidth, \y1 - \ambitusBarHeight cm) --
      (\x1 - 0.75 * \blackKeyWidth, \y2 + 0.5 * \ambitusBarHeight cm)
      node[midway, anchor=mid east, xshift=\labelOffset] (#1-midpoint) { #1 \IfValueT{#2}{#2} } --
      (\x1 - 0.25 * \blackKeyWidth, \y2 + 0.5 * \ambitusBarHeight cm)
      % let \p3=(#1-midpoint) in
      % (\x1 - 0.75 * \blackKeyWidth, \y3) -- (\x1 - \blackKeyWidth, \y3)
      ;

    \RenewCommandCopy\drawAmbitus\drawAmbitusOriginal

    \pgfmathsetmacro{\ambitusBarOffset}{\ambitusBarOffset + 1}
    \xdef\ambitusBarOffset{\ambitusBarOffset}

    \gdef\instrumentFamilySeparation{0.5}
  }

  \NewDocumentEnvironment{compactAmbitus}{}{\def\ambitusBarSeparation{0}}{}

  \begin{scope}[
    minimum height=\ambitusBarHeight cm,
    minimum width=\blackKeyWidth
  ]
    \begin{instrumentFamily}
      \begin{bracketedAmbitus}{Contrabass}
        \begin{compactAmbitus}
          \drawAmbitus{primary-note-start=28, primary-note-end=40, secondary-note-start=24, secondary-note-end=52}
          \drawAmbitus{primary-note-start=33, primary-note-end=45, secondary-note-end=57}
          \drawAmbitus{primary-note-start=38, primary-note-end=50, secondary-note-end=62}
          \drawAmbitus{primary-note-start=43, primary-note-end=55, secondary-note-end=67}
        \end{compactAmbitus}
        \drawAmbitus{primary-note-start=40, long-name=Cb. harmonics}
        \drawAmbitus{primary-note-start=45, is-continuation}
        \drawAmbitus{primary-note-start=47, is-continuation}
        \drawAmbitus{primary-note-start=50, is-continuation}
        \drawAmbitus{primary-note-start=52, primary-note-end=84, secondary-note-end=89, is-continuation}
      \end{bracketedAmbitus}

      \begin{bracketedAmbitus}{Cello}
        \begin{compactAmbitus}
          \drawAmbitus{primary-note-start=36, primary-note-end=53, secondary-note-end=60}
          \drawAmbitus{primary-note-start=43, primary-note-end=60, secondary-note-end=67}
          \drawAmbitus{primary-note-start=50, primary-note-end=67, secondary-note-end=74}
          \drawAmbitus{primary-note-start=57, primary-note-end=81, secondary-note-end=82}
        \end{compactAmbitus}
        \drawAmbitus{primary-note-start=48, long-name=Vcl. harmonics}
        \drawAmbitus{primary-note-start=55, is-continuation}
        \drawAmbitus{primary-note-start=60, primary-note-end=89, secondary-note-end=95, is-continuation}

        \path
          let \p1=(Vcl harmonics-high) in
          (96.5 - 21, \y1 + 0.5*\ambitusBarHeight cm)
          node[annotation, anchor=mid west, text width=14.5*\blackKeyWidth] {
            Higher harmonics are possible on stringed instruments, but not always available in sample sets.
          };
      \end{bracketedAmbitus}

      \begin{bracketedAmbitus}{Viola}
        \begin{compactAmbitus}
          \drawAmbitus{primary-note-start=48, primary-note-end=72}
          \drawAmbitus{primary-note-start=55, primary-note-end=79}
          \drawAmbitus{primary-note-start=62, primary-note-end=86}
          \drawAmbitus{primary-note-start=69, primary-note-end=93}
        \end{compactAmbitus}
        \drawAmbitus{primary-note-start=60, long-name=Vla. harmonics}
        \drawAmbitus{primary-note-start=67, is-continuation}
        \drawAmbitus{primary-note-start=72, primary-note-end=100, secondary-note-end=101, is-continuation}
      \end{bracketedAmbitus}

      \begin{bracketedAmbitus}{Violin}
        \begin{compactAmbitus}
          \drawAmbitus{primary-note-start=55, primary-note-end=79}
          \drawAmbitus{primary-note-start=62, primary-note-end=86}
          \drawAmbitus{primary-note-start=69, primary-note-end=93}
          \drawAmbitus{primary-note-start=76, primary-note-end=100}
        \end{compactAmbitus}
        \drawAmbitus{primary-note-start=67, long-name=Vln. harmonics}
        \drawAmbitus{primary-note-start=74, is-continuation}
        \drawAmbitus{primary-note-start=79, primary-note-end=108, secondary-note-end=110, is-continuation}
      \end{bracketedAmbitus}
    \end{instrumentFamily}

    \begin{instrumentFamily}
      \drawAmbitus{primary-note-start=21, primary-note-end=108, long-name=Piano, short-name=Pno.}
      \drawAmbitus{primary-note-start=23, primary-note-end=104, long-name=Harp, short-name=Harp, primary-note-start-label=C♭0, primary-note-end-label=G♯7}
      \drawAmbitus{primary-note-start=48, primary-note-end=96, secondary-note-start=36, long-name=Marimba, short-name=Mar.}
      \drawAmbitus{primary-note-start=65, primary-note-end=108, secondary-note-start=58, long-name=Xylophone, short-name=Xyl.}
      \drawAmbitus{primary-note-start=53, primary-note-end=89, secondary-note-start=48, long-name=Vibraphone, short-name=Vib.}
      \drawAmbitus{primary-note-start=60, primary-note-end=77, secondary-note-start=52, secondary-note-end=79, long-name=Tubular Bells, short-name=T. Bells}
      \drawAmbitus{primary-note-start=60, primary-note-end=108, long-name=Celesta, short-name=Cel.}
      \drawAmbitus{primary-note-start=79, primary-note-end=108, secondary-note-start=72, long-name=Glockenspiel, short-name=Glck.}
      \drawAmbitus{primary-note-start=84, primary-note-end=108, long-name=Crotales, short-name=Crot.}
      \pgfmathsetmacro{\ambitusBarOffset}{\ambitusBarOffset - 3 - 2 * \ambitusBarSeparation}
      \xdef\ambitusBarOffset{\ambitusBarOffset}
      \begin{bracketedAmbitus}{Timpani}
        \begin{compactAmbitus}
          \drawAmbitus{primary-note-start=36, primary-note-end=45, primary-color=secondary-ambitus-color}
          \drawAmbitus{primary-note-start=41, primary-note-end=48}
          \drawAmbitus{primary-note-start=46, primary-note-end=53}
          \drawAmbitus{primary-note-start=50, primary-note-end=57}
          \drawAmbitus{primary-note-start=53, primary-note-end=61, primary-color=secondary-ambitus-color}
        \end{compactAmbitus}
      \end{bracketedAmbitus}
    \end{instrumentFamily}

    \pgfmathsetmacro{\ambitusBarOffset}{\ambitusBarOffset - 1 + \keyboardHeight/\ambitusBarHeight + \keyboardPaddingAbove}
    \xdef\ambitusBarOffset{\ambitusBarOffset}

    \begin{instrumentFamily}
      \drawAmbitus{primary-note-start=22, primary-note-end=63, long-name=B♭ Tuba, short-name=B♭ Tuba}
      \drawAmbitus{primary-note-start=26, primary-note-end=64, secondary-note-start=24, long-name=C Tuba, short-name=C Tuba}
      \drawAmbitus{primary-note-start=35, primary-note-end=72, long-name=B♭ Euphonium, short-name=B♭ Euph.}
      \drawAmbitus{primary-note-start=40, primary-note-end=72, long-name=B♭ Baritone, short-name=B♭ Bar.}
      \drawAmbitus{primary-note-start=35, primary-note-end=77, long-name=F Wagner Tuba, short-name=F Wag.}
      \drawAmbitus{primary-note-start=40, primary-note-end=77, long-name=B♭ Wagner Tuba, short-name=B♭ Wag.}
      \drawAmbitus{primary-note-start=34, primary-note-end=77, long-name=Bass Trombone, short-name=B. Tbn.}
      \drawAmbitus{primary-note-start=40, primary-note-end=77, long-name=Trombone, short-name=Tbn.}
      \drawAmbitus{primary-note-start=40, primary-note-end=72, long-name=B♭ Bass Trumpet, short-name=B♭ B. Tpt.}
      \drawAmbitus{primary-note-start=52, primary-note-end=82, secondary-note-start=51, long-name=B♭ Trumpet, short-name=B♭ Tpt.}
      \drawAmbitus{primary-note-start=54, primary-note-end=84, secondary-note-start=53, long-name=C Trumpet, short-name=C Tpt.}
      \drawAmbitus{primary-note-start=64, primary-note-end=91, secondary-note-start=62, long-name=B♭ Piccolo Trumpet, short-name=B♭ Picc. Tpt.}
      \drawAmbitus{primary-note-start=31, primary-note-end=77, long-name=French Horn, short-name=Hn.}

      \path
        let \p1=(C Trumpet-low) in
        (0, \y1)
        node[annotation, anchor=north west, text width=7.5*\blackKeyWidth] {
          Lower pedal tones are possible on brass instruments.
        };
    \end{instrumentFamily}

    \begin{instrumentFamily}
      \drawAmbitus{primary-note-start=37, primary-note-end=75, secondary-note-start=36, long-name=Baritone Saxophone, short-name=Bar. Sax.}
      \drawAmbitus{primary-note-start=44, primary-note-end=82, long-name=Tenor Saxophone, short-name=T. Sax.}
      \drawAmbitus{primary-note-start=49, primary-note-end=87, long-name=Alto Saxophone, short-name=A. Sax.}
      \drawAmbitus{primary-note-start=56, primary-note-end=94, long-name=Soprano Saxophone, short-name=S. Sax.}

      \path
        let \p1=(Soprano Saxophone-high) in
        (\x1 + 3.75 * \blackKeyWidth, \y1 + \ambitusBarHeight cm)
        node[annotation, anchor=mid west, text width=12.75*\blackKeyWidth] {
          Higher notes are possible on wind instruments, but increasingly difficult to sound and not always available in sample sets.
        };
    \end{instrumentFamily}

    \begin{instrumentFamily}
      \tikzset{instrument label/.style={anchor=north west, xshift=-\labelOffset, yshift=-0.2*\ambitusBarHeight cm}}
      \drawAmbitus{primary-note-start=22, primary-note-end=60, secondary-note-start=21, long-name=Contrabassoon, short-name=Cbsn.}
      \tikzset{instrument label/.style={}}
      \drawAmbitus{primary-note-start=34, primary-note-end=75, secondary-note-end=77, long-name=Bassoon, short-name=Bsn.}
      \tikzset{instrument label/.style={anchor=north west, xshift=-\labelOffset, yshift=-0.2*\ambitusBarHeight cm}}
      \drawAmbitus{primary-note-start=22, primary-note-end=67, long-name=Contrabass Clarinet, short-name=Cb. Cl.}
      \tikzset{instrument label/.style={}}
      \drawAmbitus{primary-note-start=34, primary-note-end=79, secondary-note-end=83, long-name=Bass Clarinet, short-name=B.Cl.}
      \drawAmbitus{primary-note-start=43, primary-note-end=79, secondary-note-start=42, secondary-note-end=84, long-name=E♭ Alto Clarinet, short-name=A.Cl.}
      \drawAmbitus{primary-note-start=50, primary-note-end=91, long-name=B♭ Clarinet, short-name=B♭ Cl.}
      \drawAmbitus{primary-note-start=55, primary-note-end=95, long-name=E♭ Clarinet, short-name=E♭ Cl.}
      \drawAmbitus{primary-note-start=45, primary-note-end=79, secondary-note-end=84, long-name=Heckelphone, short-name=Heck.}
      \drawAmbitus{primary-note-start=52, primary-note-end=83, long-name=English Horn, short-name=EH}
      \drawAmbitus{primary-note-start=58, primary-note-end=91, secondary-note-end=96, long-name=Oboe, short-name=Ob.}
      \drawAmbitus{primary-note-start=55, primary-note-end=88, long-name=Alto Flute, short-name=A.Fl.}
      \drawAmbitus{primary-note-start=60, primary-note-end=98, secondary-note-start=59, long-name=Flute, short-name=Fl.}
      \drawAmbitus{primary-note-start=74, primary-note-end=108, long-name=Piccolo, short-name=Picc.}
    \end{instrumentFamily}
  \end{scope}

  \path
    let \p1=(Piccolo-high) in
    (0.5 * \blackKeyWidth - \minNoteMidpoint * \noteImageScaleFactor, -\bottomNotePadding)
    node[anchor=north west] {
      \includegraphics[scale=\noteImageScaleFactor]{notes-bottom.pdf}
    }
    ++(0, \y1 - \ambitusBarHeight cm + \bottomNotePadding cm)
    node[anchor=south west] {
      \includegraphics[scale=\noteImageScaleFactor]{notes-top.pdf}
    };
\end{tikzpicture}

\clearpage
\pagestyle{plain}

\begin{multicols*}{4}
  \scriptsize
  \addfontfeature{Numbers=OldStyle}

  \section*{Instrument Transpositions}

  \begin{tabular}{@{}lll@{}} \toprule
    Instrument          & To Concert Pitch        \\ \midrule
    Piccolo             & octave up               \\
    Alto Flute          & 4th down                \\
    English Horn        & 5th down                \\
    Heckelphone         & octave down             \\
    E♭ Clarinet         & minor~3rd up            \\
    B♭ Clarinet         & 2nd down                \\
    E♭ Alto Clarinet    & minor 6th down          \\
    Bass Clarinet       & 2nd + octave down       \\
    Contrabass Clarinet & 2nd + 2 octaves down    \\
    Contrabassoon       & octave down             \\ \midrule
    Soprano Saxophone   & 2nd down                \\
    Alto Saxophone      & minor 6th down          \\
    Tenor Saxophone     & 2nd + octave down       \\
    Baritone Saxophone  & minor 6th + octave down \\ \midrule
    French Horn in F    & \begin{tabular}{@{}l@{}}
                            5th down, treble \& new bass clef \\
                            4th up, old bass clef
                          \end{tabular}           \\
    B♭ Piccolo Trumpet  & minor 7th up            \\
    B♭ Trumpet          & 2nd down                \\
    B♭ Bass Trumpet     & 2nd + octave down       \\
    B♭ Wagner Tuba      & 2nd down                \\
    F Wagner Tuba       & 5th down                \\
    B♭ Baritone         & 2nd + octave down       \\
    B♭ Euphonium        & 2nd + octave down       \\ \midrule
    Crotales            & 2 octaves up            \\
    Glockenspiel        & 2 octaves up            \\
    Celesta             & octave up               \\
    Xylophone           & octave up               \\ \midrule
    Contrabass          & octave down             \\ \bottomrule
  \end{tabular}


  \section*{Note Names}

  \def\rolandOctaves{“Roland” octaves (used in Ableton Live and Native Instruments Kontakt, concert pitch is {\addfontfeature{Numbers=Lining}A3})}
  \def\yamahaOctaves{“Yamaha” octaves (Apple Logic’s default and used in FabFilter {\addfontfeature{Numbers=Lining}Pro-Q~3}, concert pitch is {\addfontfeature{Numbers=Lining}A4})}

  Note names have
  \ifnum\octaveOffset>1\relax
    \rolandOctaves. Add 1 for \yamahaOctaves.
  \else
    \yamahaOctaves. Subtract 1 for \rolandOctaves.
  \fi


  \section*{Page Numbers of References}

  For more information about instruments and orchestration:

  \newcolumntype{R}{>{\addfontfeature{Numbers={Lining,Monospaced}}}r}

  \def\thinrule{\specialrule{\cmidrulewidth}{0.5\aboverulesep}{0.5\belowrulesep}}

  \newlength\instrumentWidth
  \settowidth{\instrumentWidth}{Contrabass Clarinet}

  \addtolength{\tabcolsep}{-0.4em}

  % A longtable environment would be preferred, but longtable can’t be used in a
  % multicols environment.
  \begin{tabular}[t]{@{}p{\instrumentWidth}RRRR@{}} \toprule
                        & \multicolumn{4}{c}{Page Numbers} \\ \cmidrule(){2-5}
    Instrument          & \citeauthor{adler}    & \citeauthor{blatter}                     & \citeauthor{forsyth}    & \citeauthor{sevsay}    \\ \midrule
    Piccolo             & \notecite[198]{adler} & \multirow{3}{*}{\notecite[90]{blatter}}  & \notecite[198]{forsyth} & \notecite[76]{sevsay}  \\
    Flute               & \notecite[189]{adler} &                                          & \notecite[182]{forsyth} & \notecite[75]{sevsay}  \\
    Alto Flute          & \notecite[201]{adler} &                                          & \notecite[196]{forsyth} & \notecite[77]{sevsay}  \\ \thinrule
    Oboe                & \notecite[204]{adler} & \multirow{3}{*}{\notecite[98]{blatter}}  & \notecite[204]{forsyth} & \notecite[78]{sevsay}  \\
    English Horn        & \notecite[209]{adler} &                                          & \notecite[220]{forsyth} & \notecite[79]{sevsay}  \\
    Heckelphone         & \notecite[216]{adler} &                                          & \notecite[228]{forsyth} & \notecite[80]{sevsay}  \\ \thinrule
    E♭ Clarinet         & \notecite[224]{adler} & \multirow{5}{*}{\notecite[105]{blatter}} & \notecite[278]{forsyth} & \notecite[82]{sevsay}  \\
    B♭ Clarinet         & \notecite[217]{adler} &                                          & \notecite[251]{forsyth} & \notecite[80]{sevsay}  \\
    E♭ Alto Clarinet    & \notecite[228]{adler} &                                          & \notecite[282]{forsyth} & \notecite[83]{sevsay}  \\
    Bass Clarinet       & \notecite[225]{adler} &                                          & \notecite[272]{forsyth} & \notecite[82]{sevsay}  \\
    Contrabass Clarinet & \notecite[230]{adler} &                                          & \notecite[286]{forsyth} & \notecite[84]{sevsay}  \\ \thinrule
    Bassoon             & \notecite[235]{adler} & \multirow{2}{*}{\notecite[116]{blatter}} & \notecite[229]{forsyth} & \notecite[84]{sevsay}  \\
    Contrabassoon       & \notecite[240]{adler} &                                          & \notecite[246]{forsyth} & \notecite[85]{sevsay}  \\ \midrule
    Saxophones          & \notecite[231]{adler} & \notecite[126]{blatter}                  & \notecite[166]{forsyth} & \notecite[87]{sevsay}  \\ \bottomrule
  \end{tabular}

  % \vfill\null
  \columnbreak

  \emph{(Page numbers of references, cont.)}\\
  \begin{tabular}[t]{@{}p{\instrumentWidth}RRRR@{}} \toprule
                        & \multicolumn{4}{c}{Page Numbers} \\ \cmidrule(){2-5}
    Instrument          & \citeauthor{adler}    & \citeauthor{blatter}                     & \citeauthor{forsyth}    & \citeauthor{sevsay}    \\ \midrule
    French Horn         & \notecite[337]{adler} & \notecite[148]{blatter}                  & \notecite[109]{forsyth} & \notecite[96]{sevsay}  \\
    Trumpets            & \notecite[357]{adler} & \notecite[159]{blatter}                  & \notecite[89]{forsyth}  & \notecite[101]{sevsay} \\
    Trombones           & \notecite[368]{adler} & \notecite[169]{blatter}                  & \notecite[133]{forsyth} & \notecite[103]{sevsay} \\
    Wagner Tubas        & —                     & \notecite[148]{blatter}                  & \notecite[153]{forsyth} & \notecite[111]{sevsay} \\
    Tubas               & \notecite[377]{adler} & \notecite[178]{blatter}                  & \notecite[151]{forsyth} & \notecite[108]{sevsay} \\ \midrule
    Timpani             & \notecite[485]{adler} & \notecite[209]{blatter}                  & \notecite[41]{forsyth}  & \notecite[167]{sevsay} \\ \midrule
    Crotales            & \notecite[481]{adler} & \notecite[206]{blatter}                  & —                       & \notecite[161]{sevsay} \\
    Glockenspiel        & \notecite[479]{adler} & \notecite[205]{blatter}                  & \notecite[60]{forsyth}  & \notecite[150]{sevsay} \\
    Tubular Bells       & \notecite[480]{adler} & \notecite[205]{blatter}                  & \notecite[53]{forsyth}  & \notecite[155]{sevsay} \\
    Celesta             & \notecite[528]{adler} & \notecite[206]{blatter}                  & \notecite[64]{forsyth}  & \notecite[245]{sevsay} \\
    Vibraphone          & \notecite[477]{adler} & \notecite[205]{blatter}                  & —                       & \notecite[152]{sevsay} \\
    Xylophone           & \notecite[475]{adler} & \notecite[204]{blatter}                  & \notecite[66]{forsyth}  & \notecite[147]{sevsay} \\
    Marimba             & \notecite[476]{adler} & \notecite[204]{blatter}                  & —                       & \notecite[149]{sevsay} \\ \midrule
    Harp                & \notecite[95]{adler}  & \notecite[252]{blatter}                  & \notecite[461]{forsyth} & \notecite[194]{sevsay} \\
    Piano               & \notecite[521]{adler} & \notecite[242]{blatter}                  & —                       & \notecite[230]{sevsay} \\ \midrule
    Violin              & \notecite[57]{adler}  & \notecite[49, 441]{blatter}              & \notecite[303]{forsyth} & \multirow{4}{*}{\notecite[3]{sevsay}} \\
    Viola               & \notecite[71]{adler}  & \notecite[56, 442]{blatter}              & \notecite[381]{forsyth} &                        \\
    Cello               & \notecite[81]{adler}  & \notecite[60, 443]{blatter}              & \notecite[409]{forsyth} &                        \\
    Contrabass          & \notecite[89]{adler}  & \notecite[67, 444]{blatter}              & \notecite[436]{forsyth} &                        \\ \bottomrule
  \end{tabular}

  \nocite{vienna-academy}

  \renewcommand*\bibfont{\scriptsize}
  \setlength\bibhang{10pt}
  \setlength\bibitemsep{\parskip}
  \printbibliography


  \section*{Legal}

  % https://www.ableton.com/en/legal/trademark-list/
  Ableton and Live are trademarks of Ableton AG.

  % https://www.apple.com/legal/intellectual-property/trademark/appletmlist.html
  Apple and Logic are trademarks of Apple Inc., registered in the U.S. and other countries and regions.

  % https://tsdr.uspto.gov/#caseNumber=79394860&caseSearchType=US_APPLICATION&caseType=DEFAULT&searchType=statusSearch
  FabFilter is a trademark of FabFilter BV.

  % https://tsdr.uspto.gov/#caseNumber=73083201&caseSearchType=US_APPLICATION&caseType=DEFAULT&searchType=statusSearch
  Roland is a registered trademark of Roland Corporation.

  % https://tsdr.uspto.gov/#caseNumber=77642839&caseSearchType=US_APPLICATION&caseType=DEFAULT&searchType=statusSearch
  Vienna Symphonic Library is a registered trademark of Vienna Symphonic Library GmbH.

  % https://www.yamaha.com/paragon/trademarkguidelines/
  Yamaha is a registered trademark of Yamaha Corporation.
\end{multicols*}

\end{document}
